<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>SonicBase - Features</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="desription" content="A list of features that SonicBase supports. Fetures of the free and pro version are listed.">
    <link href="../css/singlePageTemplate.css" rel="stylesheet" type="text/css">


    <script type="text/javascript" src="../javascript/main.js"></script>

    <link rel="stylesheet" href="../css/tomorrow-night-bright.css">
    <script src="../javascript/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

</head>

<body>
<div class="container">
    <header id="myHeader">
        <div class="mobile">
            <a href="../index.html">
                <h4 class="logo">SonicBase™</h4>
            </a>
        </div>

        <div class="desktop">
            <a href="../index.html">
                <img style="margin-top:3px" src="../images/logo-white.gif" width="50px"/><h4 class="logo">SonicBase™</h4>
            </a>
        <nav>
            <ul>
                <li><a href="../index.html">HOME</a></li>
                <li> <a href="../documentation.html">DOCUMENTATION</a></li>
                <li><a href="../contact.html">CONTACT</a></li>
            </ul>
        </nav>
        </div>
    </header>

    <script>
        if (isFramed()) {
            document.getElementById("myHeader").style.display = "none";
        }
    </script>

    <div style="margin-left: 4em;margin-right: 4em;">

        <br/><br/><br/>
        <h1>Overview</h1>
        With SonicBase you can publish messages from from inserts, updates and deletes that occur to the database.
        The current messaging platforms that are supported include Kafka and Amazon Web Services Message
        Queue Service. Additionally, we support custom message providers. Your queue will receive messages from SonicBase
        in the format described below.
        <h1>Performance Considerations</h1>
        You must have an extremely fast message queue provider when hooking a producer into Sonicbase. Otherwise performance
        will greatly suffer.
        <h1>Configuration</h1>
        You configure message queue integration in the cluster config file. In the configuration you create a "queue" section where you specify
        an array of "producer"s. Each producer has a "className", "maxBatchSize" and provider specific config.

        <h2>Example</h2>
        <pre class="JSON"><code>
    {
        "dataDirectory": "$HOME/db-data",
        "installDirectory": "$HOME/sonicbase",
        "compressRecords": false,
        "useUnsafe": true,
        "maxJavaHeap": "60%",
        "user": "ubuntu",
        "clientIsPrivate": false,
        "queue": {
            "producers" : [ {
                "maxBatchSize" : 100,
                "className" : "com.sonicbase.queue.AWSSQSMessageQueueProducer",
                "url" : "https://sqs.us-east-1.amazonaws.com/892217754330/benchmark-queue"
            },
            {
                "servers" : "10.0.0.231:9092",
                "maxBatchSize" : 100,
                "topic" : "test",
                "className" : "com.sonicbase.queue.KafkaMessageQueueProducer"
            } ]
        }
    }
            </code></pre>
        <h1>Message Format</h1>
        <h2>Header</h2>
        The outermost part of the json must contain the following fields:<br/>
        <lu>
            <li>database - the name of the database for the affected records</li>
            <li>table - the name of the table to for the affected records</li>
            <li>action - the action that triggered the publish of the message. The action may be "insert", "update" or "delete".</li>
        </lu>
        <br/>
        The "records" section contains an array of records that are being publishee. <br/>
        <br/>
        Binary fields are base64 encoded.

        <h2>Example Message</h2>
        <pre class="JSON"><code>
    {
        "database": "test",
        "table": "persons",
        "action": "insert",
        "records": [
            {
                "id": 123,
                "name": "bob"
            },
            {
                "id": 124,
                "name": "sue"
            },
        ]
    }
            </code></pre>
        <h1>Administration</h1>
        In order for AWS integration to work you must have a file named "&lt;cluster&gt;-awskeys" located in the
        "keys" subdirectory of the install directory. This file contains the accesskey on the first line and the
        secret key on the second line.

        <h1>Custom Message Providers</h1>
        You can hook into any messaging system by providing a custom provider. Your class must implement the following
        interface located in sonicbase-&lt;version&gt;.jar.<br/><br/>

        <pre class="java"><code>
    package com.sonicbase.queue;<br/>

    public interface MessageQueueProducer {<br/>

        void init(String cluster, String jsonConfig, String jsonQueueConfig);<br/>

        void publish(String message);<br/>

        void shutdown();<br/>
`   }<br/>
            </code></pre>
        "init" is called once per thread to give you a chance to create your thread-specific producer.<br/>
        <br/>
        "publish" is called for you send a message to your message queue.<br/>
        <br/>
        "shutdown" is called for you to disconnect from your provider.<br/>
        <br/>

        <h1>Example Custom Provider</h1>
        Below is an example provider that is based on the Kafka provider built into
        SonicBase. For your provider to work, you must place the jar containing your code and any dependencies in the "lib"
        directory under the install directory and deploy it across the cluster.<br/>
        <pre class="java"><code>
package com.sonicbase.queue;<br/>

public class KafkaMessageQueueProducer implements MessageQueueProducer {
  private String topic;
  private Producer&lt;String, String&gt; producer;<br/>

  @Override
  public void init(String cluster, String jsonConfig, String jsonQueueConfig) {<br/>

    JsonDict queueConfig = new JsonDict(jsonQueueConfig);
    String servers = queueConfig.getString("servers");
    this.topic = queueConfig.getString("topic");<br/>

    Properties props = new Properties();
    props.put("bootstrap.servers", servers);
    props.put("acks", "all");
    props.put("retries", 0);
    props.put("batch.size", 16384);
    props.put("linger.ms", 1);
    props.put("buffer.memory", 33554432);
    props.put("key.serializer", "org.apache.kafka.common.serialization.StringSerializer");
    props.put("value.serializer", "org.apache.kafka.common.serialization.StringSerializer");<br/>

    producer = new KafkaProducer<>(props);
  }<br/>

  @Override
  public void publish(String message) {
    try {
      Future&lt;RecordMetadata&gt; response = producer.send(new ProducerRecord<>(topic, "message", message));
      response.get();
    }
    catch (Exception e) {
      throw new DatabaseException(e);
    }
  }<br/>

  @Override
  public void shutdown() {
  }
}
            </code></pre>

    </div>
</div>
</body>
</html>
